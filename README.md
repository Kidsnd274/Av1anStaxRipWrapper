# Av1anStaxRipWrapper
Python wrapper script to use Av1an with StaxRip
 - Currently only the rav1e script is working

INSTALL AND USAGE GUIDE (YouTube) (not done yet)

## Contents
- [Usage](#usage)
- [Requirements](#requirements)
- [Setup](#setup)
- [Command Line Options](#command-line-options)

## Usage
This script makes use of the Command Line option in StaxRip. There are some required arguments needed in the command that allows Av1an to work with StaxRip. Namely `-i "%source_file%" -o "%encoder_out_file%" -t "%temp_dir%av1an_temp"`. `-s "%startup_dir%"` is needed if you want a portable installation. Portable installation is described in more detail at the [Setup](#setup) section.

<img src="https://user-images.githubusercontent.com/1343896/209447195-c6ffb08c-bb6c-4792-a1cd-a09422c01156.png" alt="staxrip_image" width="500"/>

A good starting command would be:

```
"%app_path:python%" "%startup_dir%\Apps\Encoders\Av1anStaxRipWrapper\Av1anStaxRipWrapperRav1e.py" -s "%startup_dir%" -i "%source_file%" -o "%encoder_out_file%" -t "%temp_dir%av1an_temp" --quantizer 60 --speed 6 --tiles 2 --threads 2 --photon-noise 2 --chroma-noise --sc-downscale-height 540
```
Everything after the `-t` parameter will affect the encoding parameters (either Av1an or rav1e). Refer to [Command Line Options](#command-line-options) section for more information.

## Requirements
- [ffmpeg](https://ffmpeg.org/download.html) (with shared libraries) (Av1an requirement)
- [rav1e](https://github.com/xiph/rav1e/releases)
- [StaxRip](https://github.com/staxrip/staxrip/releases)

Since Av1an requires `ffmpeg`, `rav1e` to be in PATH, this script can automatically help you add important folders to PATH when it's being run (for a more portable installation). Either follow the instructions in [Setup](#setup) or install the requirements yourself and add them to system PATH.

This script also requires the `psutil` module in Python to automatically detect CPU core counts to pass into av1an.
 - You can run with the `--disable-automatic-thread-detection` flag to disable this

## Setup

## Command Line Options
```
options:
  -h, --help            show this help message and exit
  -i INPUT              Input File (for StaxRip)
  -o OUTPUT             Output File (for StaxRip)
  -t TEMPDIR            Temp Directory (for StaxRip)
  -s STAXRIP_STARTUP_DIR, --staxrip-startup-dir STAXRIP_STARTUP_DIR
                        Specify StaxRip Startup Directory so that the wrapper script will automatically 
                        add important folders to PATH for av1an to detect (only needed for portable installations)

# Av1an parameters
  --photon-noise PHOTON_NOISE
                        Generates a photon noise table and applies it using grain synthesis 
                        [strength: 0-64] (disabled by default) (Av1an parameter)
  --chroma-noise        Adds chroma grain synthesis to the grain table generated by `--photon-noise`. 
                        (Default: false) (Av1an parameter)
  --sc-downscale-height SC_DOWNSCALE_HEIGHT
                        Optional downscaling for scene detection. By default, no downscaling is performed. (Av1an parameter)

# Thread Management parameters (Using any of these would disable the wrapper's Automatic Thread Detection feature)
  --workers WORKERS     Number of workers to spawn [0 = automatic] (Av1an Paramter)
  --set-thread-affinity SET_THREAD_AFFINITY
                        Pin each worker to a specific set of threads of this size (disabled by default) (Av1an parameter)
  --disable-automatic-thread-detection
                        Disable the wrapper's automatic thread detection (Wrapper script flag)

# rav1e parameters
  --quantizer QUANTIZER
                        Quantizer (0-255), smaller values are higher quality (default: 100) (rav1e parameter)
  --speed SPEED         Speed level (0 is best quality, 10 is fastest) Speeds 10 and 0 are extremes and are generally 
                        not recommended [default: 6] (rav1e parameter)
  --tiles TILES         Number of tiles. Tile-cols and tile-rows are overridden so that the video has at least this 
                        many tiles (rav1e parameter)
  --threads THREADS     Set the threadpool size. If 0, will use the number of logical CPUs. rav1e will use up to this 
                        many threads. Additional tiles may be needed to increase thread utilization
                        [default: 0] (rav1e parameter)
```

## Automatic Thread Detection
In my testing, I found that I get the best utilization and encoding speeds when creating the same number of workers as 
